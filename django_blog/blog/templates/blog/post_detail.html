{% extends 'base.html' %}
{% load static %}
{% block title %}{{ post.title }}{% endblock %}

{% block content %}
    <article class="post-detail">
        <h1>{{ post.title }}</h1>
        <p class="post-meta">
            By {{ post.author.username }} on {{ post.published_date|date:"F d, Y" }}
        </p>

        {% if user.is_authenticated and user.id == post.author.id %}
            <div class="post-actions">
                <a href="{% url 'post-update' pk=post.pk %}" class="btn btn-edit">Edit Post</a> |
                <a href="{% url 'post-delete' pk=post.pk %}" class="btn btn-delete">Delete Post</a>
            </div>
        {% endif %}
        
        <div class="post-tags-container">
            <strong>Tags:</strong> 
            {% for tag in post.tags.all %}
                <a href="{% url 'post-by-tag' tag_slug=tag.slug %}" class="tag-link">{{ tag.name }}</a>
            {% empty %}
                No tags.
            {% endfor %}
        </div>
        <div class="post-content">
            <p>{{ post.content|linebreaksbr }}</p>
        </div>
    </article>
    <p><a href="{% url 'post-list' %}">&larr; Back to All Posts</a></p>
    
    <hr>
    
    <section class="comments-section">
        <h2>Comments ({{ post.comments.count }})</h2>

        {% if user.is_authenticated %}
            <div class="comment-form-container">
                <h3>Leave a Comment</h3>
                <form method="POST" action="{% url 'comment-create' pk=post.pk %}" class="comment-form">
                    {% csrf_token %}
                    {{ comment_form.as_p }}
                    <button type="submit" class="btn btn-primary">Post Comment</button>
                </form>
            </div>
        {% else %}
            <p>Please <a href="{% url 'login' %}">log in</a> to leave a comment.</p>
        {% endif %}

        <div class="existing-comments">
            {% for comment in post.comments.all %}
                <div class="comment-box">
                    <p class="comment-author">
                        <strong>{{ comment.author.username }}</strong> 
                        <span class="comment-date">on {{ comment.created_at|date:"M d, Y H:i" }}</span>
                    </p>
                    <p class="comment-content">{{ comment.content|linebreaksbr }}</p>

                    {% if user.is_authenticated and user.id == comment.author.id %}
                        <div class="comment-actions">
                            <a href="{% url 'comment-update' pk=comment.pk %}" class="btn btn-edit btn-small">Edit</a>
                            <a href="{% url 'comment-delete' pk=comment.pk %}" class="btn btn-delete btn-small">Delete</a>
                        </div>
                    {% endif %}
                </div>
            {% empty %}
                <p>No comments yet. Be the first to start the discussion!</p>
            {% endfor %}
        </div>
    </section>
    {% endblock %}
